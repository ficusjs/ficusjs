class t{constructor(t,s,e={}){this.namespace=t,this.storage=s,this.options=e,this._init()}_init(){if("performance"in globalThis&&this.options.clearOnReload){const t=globalThis.performance.getEntriesByType("navigation").map((t=>t.type));this.lastUpdated()&&t.includes("reload")&&this.removeState()}}setState(t){t?(this.storage.setItem(`${this.namespace}:state`,this._normalizeState(t)),this.storage.setItem(`${this.namespace}:lastUpdated`,(new Date).getTime().toString())):this.removeState()}_normalizeState(t){return"object"==typeof t&&this.options.saveState&&"function"==typeof this.options.saveState?JSON.stringify(this.options.saveState(t)):"string"!=typeof t?JSON.stringify(t):t}getState(){const t=this.storage.getItem(`${this.namespace}:state`);return t?JSON.parse(t):void 0}lastUpdated(){const t=this.storage.getItem(`${this.namespace}:lastUpdated`);return t?parseInt(t,10):void 0}removeState(){this.storage.removeItem(`${this.namespace}:state`),this.storage.removeItem(`${this.namespace}:lastUpdated`)}}function createPersist(s,e="session",i){return new t(s,"local"===e?globalThis.localStorage:globalThis.sessionStorage,i)}const s=Object.freeze({INIT:-1,NOT_STARTED:0,RUNNING:1,STOPPED:2});function withXStateService(t,e){return{...e,created(){this._subscribeCallback=()=>{this.computedCache={},this._processRender()},this.setXStateService(t),e.created&&e.created.call(this)},mounted(){this._subscribeToFsmService(!1),e.mounted&&e.mounted.call(this)},updated(){this._subscribeToFsmService(!1),e.updated&&e.updated.call(this)},removed(){this._unsubscribeFromFsmService(),e.removed&&e.removed.call(this)},setXStateService(t){this.fsm=t&&t.status!==s.INIT?t:function(t,e,i){const a={_xstateService:t,_getterCache:{},_persist:"string"==typeof i?createPersist(i):i,get status(){return this._xstateService?this._xstateService.status:s.INIT},get state(){return this._xstateService.state},subscribe(t){return this._xstateService.subscribe((()=>{this._getterCache={},this._persist&&this._xstateService.status===s.RUNNING&&this._persist.setState(this._xstateService.state),t()}))},send(t){this._xstateService.send(t)},start(){this._xstateService.start(this._persist?this._persist.getState():void 0)}};return e&&(a.getters=new Proxy(e,{get(t,s){if(!a._getterCache[s]){const e=t[s](a._xstateService.state.context);a._getterCache[s]=e}return a._getterCache[s]}})),a}(t),this._fsmSubscriptionCallback=()=>{this.fsm.status===s.RUNNING&&this._fsmSubscription&&this._subscribeCallback()},this._subscribeToFsmService()},_startFsmService(){this.fsm&&this._fsmSubscription&&this.fsm.status===s.NOT_STARTED&&this.fsm.start()},_subscribeToFsmService(t=!0){this.fsm&&this.fsm.status!==s.INIT&&!this._fsmSubscription&&(this._fsmSubscription=this.fsm.subscribe(this._fsmSubscriptionCallback),t&&this._fsmSubscriptionCallback(),this._startFsmService())},_unsubscribeFromFsmService(){this.fsm&&this.fsm.status!==s.INIT&&this._fsmSubscription&&"function"==typeof this._fsmSubscription&&(this._fsmSubscription(),this._fsmSubscription=null)}}}export{withXStateService};
